<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÙˆÙ‚ Ø¹Ø²Ø§Ù† Ø§Ù„Ù…ÙˆØ­Ø¯ ğŸ›’</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@500;800;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        :root { --primary: #004d40; --orange: #ff6d00; --bg: #f0f4f7; --text: #2c3e50; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text); overflow-x: hidden; }
        .container { max-width: 800px; margin: auto; min-height: 100vh; background: #fdfdfd; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        .header { background: linear-gradient(135deg, var(--primary), #00796b); color: white; padding: 40px 20px; text-align: center; border-radius: 0 0 40px 40px; }
        .header h1 { margin: 0; font-size: 1.8rem; font-weight: 900; }
        .main-content { padding: 0 20px; margin-top: -30px; }
        .section-card { background: white; border-radius: 25px; padding: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.06); margin-bottom: 20px; border: 1px solid #eee; }
        .grid-small { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; }
        .offer-box { background: white; border-radius: 20px; padding: 15px; text-align: center; cursor: pointer; transition: 0.3s; border: 1px solid #eee; }
        .offer-box:active { transform: scale(0.95); }
        .offer-box b { font-weight: 800; display: block; margin-top: 8px; font-size: 0.9rem; }
        .status-tag { font-size: 0.7rem; font-weight: 800; padding: 3px 8px; border-radius: 8px; margin-top: 8px; display: inline-block; }
        .has { background: #e8f5e9; color: #2e7d32; }
        .none { background: #f5f5f5; color: #9e9e9e; }
        .m-btn { width: 100%; padding: 18px; border-radius: 15px; border: none; background: var(--primary); color: white; font-family: 'Tajawal'; font-weight: 900; font-size: 1.1rem; cursor: pointer; transition: 0.2s; }
        .m-btn:hover { opacity: 0.9; }
        .full-page { display: none; position: fixed; top: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 800px; height: 100%; background: var(--bg); z-index: 9999; overflow-y: auto; }
        .top-nav { background: white; padding: 15px; display: flex; align-items: center; gap: 15px; position: sticky; top: 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 10; }
        .back-btn { background: #eee; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; }
        .directory-list { display: flex; overflow-x: auto; gap: 10px; padding: 10px 0; scrollbar-width: none; }
        .dir-pill { background: var(--primary); color: white; padding: 10px 20px; border-radius: 25px; font-weight: 800; white-space: nowrap; cursor: pointer; }
        .product-card { background: white; margin: 10px 0; padding: 15px; border-radius: 20px; border-right: 6px solid #ddd; box-shadow: 0 3px 10px rgba(0,0,0,0.05); }
        input, select { width: 100%; padding: 15px; margin-bottom: 10px; border-radius: 12px; border: 1.5px solid #ddd; font-family: 'Tajawal'; font-weight: 700; box-sizing: border-box; outline: none; }
        input:focus { border-color: var(--primary); }
    </style>
</head>
<body>

    <audio id="waterSnd" preload="auto"><source src="https://www.soundjay.com/nature/sounds/water-droplet-1.mp3"></audio>

    <div class="container">
        <div class="header">
            <h1>Ø³ÙˆÙ‚ Ø¹Ø²Ø§Ù† Ø§Ù„Ù…ÙˆØ­Ø¯ ğŸ›’</h1>
            <p>Ø¯Ù„ÙŠÙ„Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„ØªØ³ÙˆÙ‚ ÙˆØ§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</p>
        </div>

        <div class="main-content">
            <div id="winnerDiv" class="section-card" style="display:none; background: #fff9c4; border: 2px solid #f1c40f; text-align: center;">
                ğŸ† <b style="color: #d35400;">ÙØ§Ø¦Ø² Ø§Ù„ÙŠÙˆÙ…:</b> <span id="wName" style="font-weight: 900;"></span>
            </div>

            <div id="ramadanSection" class="section-card" style="border: 3px solid var(--orange); display: none;">
                <div style="color: var(--orange); font-weight: 900; margin-bottom: 10px;">ğŸŒ™ Ù…Ø³Ø§Ø¨Ù‚Ø© Ø±Ù…Ø¶Ø§Ù†</div>
                <p id="qDisplay" style="font-weight: 800;"></p>
                <button onclick="sendAns()" class="m-btn" style="background: #25D366;">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ù„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ âœ…</button>
            </div>

            <div class="section-card">
                <div style="font-weight: 900; margin-bottom: 15px;">ğŸ”¥ ØªØ®ÙÙŠØ¶Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
                <div class="grid-small">
                    <div class="offer-box" onclick="openOffers('Ù…Ø·Ø§Ø¹Ù… ÙˆÙƒÙØªÙŠØ±ÙŠØ§', 'ğŸ”')"><span>ğŸ”</span><b>Ø§Ù„Ù…Ø·Ø§Ø¹Ù…</b><span id="st-Ù…Ø·Ø§Ø¹Ù… ÙˆÙƒÙØªÙŠØ±ÙŠØ§" class="status-tag none">...</span></div>
                    <div class="offer-box" onclick="openOffers('Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©', 'ğŸ')"><span>ğŸ</span><b>Ø§Ù„Ø¨Ù‚Ø§Ù„Ø§Øª</b><span id="st-Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©" class="status-tag none">...</span></div>
                    <div class="offer-box" onclick="openOffers('Ù…ÙˆØ§Ø¯ Ø¨Ù†Ø§Ø¡ ÙˆØ³Ø¨Ø§ÙƒØ©', 'ğŸ—ï¸')"><span>ğŸ—ï¸</span><b>Ø§Ù„Ø¨Ù†Ø§Ø¡</b><span id="st-Ù…ÙˆØ§Ø¯ Ø¨Ù†Ø§Ø¡ ÙˆØ³Ø¨Ø§ÙƒØ©" class="status-tag none">...</span></div>
                    <div class="offer-box" onclick="openOffers('Ù…ÙˆØ§Ø¯ ÙƒÙ‡Ø±Ø¨Ø§Ø¡', 'âš¡')"><span>âš¡</span><b>Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</b><span id="st-Ù…ÙˆØ§Ø¯ ÙƒÙ‡Ø±Ø¨Ø§Ø¡" class="status-tag none">...</span></div>
                    <div class="offer-box" onclick="openOffers('Ø³Ù„Ø¹ Ù…ØªÙ†ÙˆØ¹Ø© ÙˆØ£Ø®Ø±Ù‰', 'ğŸ›’')"><span>ğŸ›’</span><b>Ø£Ø®Ø±Ù‰</b><span id="st-Ø³Ù„Ø¹ Ù…ØªÙ†ÙˆØ¹Ø© ÙˆØ£Ø®Ø±Ù‰" class="status-tag none">...</span></div>
                </div>
            </div>

            <div class="section-card">
                <div style="font-weight: 900;">ğŸ“‚ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø­Ù„Ø§Øª</div>
                <div class="directory-list">
                    <div class="dir-pill" onclick="openDir('Ù…Ø·Ø§Ø¹Ù… ÙˆÙƒÙØªÙŠØ±ÙŠØ§')">ğŸ˜ï¸ Ø§Ù„Ù…Ø·Ø§Ø¹Ù…</div>
                    <div class="dir-pill" onclick="openDir('Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©')">ğŸ± Ø§Ù„Ø¨Ù‚Ø§Ù„Ø§Øª</div>
                    <div class="dir-pill" onclick="openDir('Ù…ÙˆØ§Ø¯ Ø¨Ù†Ø§Ø¡ ÙˆØ³Ø¨Ø§ÙƒØ©')">ğŸ› ï¸ Ø§Ù„Ø¨Ù†Ø§Ø¡</div>
                    <div class="dir-pill" onclick="openDir('Ù…ÙˆØ§Ø¯ ÙƒÙ‡Ø±Ø¨Ø§Ø¡')">ğŸ’¡ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</div>
                    <div class="dir-pill" onclick="openDir('Ø³Ù„Ø¹ Ù…ØªÙ†ÙˆØ¹Ø© ÙˆØ£Ø®Ø±Ù‰')">ğŸ·ï¸ Ø£Ø®Ø±Ù‰</div>
                </div>
            </div>

            <button onclick="openPage('merchantPage')" class="m-btn" style="background: #37474f; margin-bottom: 40px;">ğŸ” Ù„ÙˆØ­Ø© Ø§Ù„ØªØ§Ø¬Ø±</button>
        </div>
    </div>

    <div id="offersPage" class="full-page">
        <div class="top-nav"><button class="back-btn" onclick="closePage('offersPage')">âœ•</button><h3 id="pgTitle" style="margin:0; font-weight:900;"></h3></div>
        <div id="offersList" style="padding:15px;"></div>
    </div>

    <div id="dirPage" class="full-page">
        <div class="top-nav"><button class="back-btn" onclick="closePage('dirPage')">âœ•</button><h3 id="dirTitle" style="margin:0; font-weight:900;"></h3></div>
        <div style="padding: 15px;">
            <input type="text" id="searchInp" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ù…Ø­Ù„..." onkeyup="searchStores()">
            <div id="dirList"></div>
        </div>
    </div>

    <div id="merchantPage" class="full-page">
        <div class="top-nav"><button class="back-btn" onclick="closePage('merchantPage')">âœ•</button><h3 style="margin:0; font-weight:900;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ù„</h3></div>
        <div id="mAuth" style="padding:30px;">
            <input type="password" id="mCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù…Ø­Ù„ Ø§Ù„Ø®Ø§Øµ">
            <button class="m-btn" onclick="loginMerchant()">Ø¯Ø®ÙˆÙ„</button>
        </div>
        <div id="mPanel" style="display:none; padding:20px;">
            <div id="mNameDisp" style="padding:15px; background:var(--primary); color:white; border-radius:15px; margin-bottom:15px; text-align:center; font-weight:900;"></div>
            <input type="text" id="pName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
            <input type="text" id="pPrice" placeholder="Ø§Ù„Ø³Ø¹Ø±">
            <select id="pType"><option value="offer">ğŸ”¥ ØªØ®ÙÙŠØ¶</option><option value="normal">ğŸ“¦ Ø¹Ø§Ø¯ÙŠ</option></select>
            <button class="m-btn" onclick="addProduct()">Ù†Ø´Ø± Ø§Ù„Ø¢Ù† âœ…</button>
            <hr style="margin:20px 0; border:0; border-top:1px solid #ddd;">
            <div style="font-weight: 800; margin-bottom: 10px;">Ù…Ù†ØªØ¬Ø§ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</div>
            <div id="mProds"></div>
            <button onclick="logout()" style="width:100%; background:none; border:none; color:red; margin-top:30px; font-weight:900; cursor:pointer;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
        const firebaseConfig = { databaseURL: "https://souq-tarim-default-rtdb.firebaseio.com/" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        function playWater() { const snd = document.getElementById('waterSnd'); snd.currentTime = 0; snd.play().catch(e=>{}); }
        function openPage(id) { playWater(); document.getElementById(id).style.display='block'; if(id==='merchantPage') checkAuth(); }
        function closePage(id) { playWater(); document.getElementById(id).style.display='none'; }

        // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ÙˆØ§Ù„Ø¬ÙˆØ§Ø¦Ø²
        db.ref('RamadanContest').on('value', snap => {
            const d = snap.val(); if(!d) return;
            document.getElementById('ramadanSection').style.display = d.status === 'on' ? 'block' : 'none';
            document.getElementById('qDisplay').innerText = d.question;
            if(d.winStatus === 'on' && d.winner) {
                document.getElementById('winnerDiv').style.display = 'block';
                document.getElementById('wName').innerText = d.winner;
            } else {
                document.getElementById('winnerDiv').style.display = 'none';
            }
        });

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© ÙˆØ¬ÙˆØ¯ Ø¹Ø±ÙˆØ¶ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        function syncStatus() {
            const cats = ['Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©', 'Ù…Ø·Ø§Ø¹Ù… ÙˆÙƒÙØªÙŠØ±ÙŠØ§', 'Ù…ÙˆØ§Ø¯ Ø¨Ù†Ø§Ø¡ ÙˆØ³Ø¨Ø§ÙƒØ©', 'Ù…ÙˆØ§Ø¯ ÙƒÙ‡Ø±Ø¨Ø§Ø¡', 'Ø³Ù„Ø¹ Ù…ØªÙ†ÙˆØ¹Ø© ÙˆØ£Ø®Ø±Ù‰'];
            db.ref('Products').on('value', pSnap => {
                const prods = pSnap.val() || {};
                db.ref('Stores').once('value', sSnap => {
                    const stores = sSnap.val() || {};
                    cats.forEach(c => {
                        let hasOffer = false;
                        Object.keys(stores).forEach(sid => {
                            if(stores[sid].category === c && prods[sid]) {
                                Object.values(prods[sid]).forEach(p => { if(p.type==='offer') hasOffer = true; });
                            }
                        });
                        const el = document.getElementById('st-'+c);
                        if(el) {
                            el.innerText = hasOffer ? "âœ… Ø¹Ø±ÙˆØ¶" : "Ù„Ø§ ÙŠÙˆØ¬Ø¯";
                            el.className = "status-tag " + (hasOffer ? "has" : "none");
                        }
                    });
                });
            });
        }
        syncStatus();

        // ÙØªØ­ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
        function openOffers(cat, icon) {
            playWater(); 
            document.getElementById('pgTitle').innerText = icon + " Ø¹Ø±ÙˆØ¶ " + cat;
            const list = document.getElementById('offersList'); 
            list.innerHTML = "<p style='text-align:center'>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØªØ®ÙÙŠØ¶Ø§Øª...</p>"; 
            openPage('offersPage');

            db.ref('Stores').orderByChild('category').equalTo(cat).once('value', sSnap => {
                const stores = sSnap.val() || {};
                db.ref('Products').once('value', pSnap => {
                    const prods = pSnap.val() || {}; 
                    list.innerHTML = "";
                    let count = 0;
                    Object.keys(stores).forEach(sid => {
                        if(prods[sid]) Object.values(prods[sid]).forEach(p => {
                            if(p.type==='offer') {
                                list.innerHTML += `<div class="product-card" style="border-right-color:var(--orange)">
                                    <b style="font-size:1.1rem">${p.name}</b> 
                                    <span style="float:left; color:var(--orange); font-weight:900;">${p.price}</span>
                                    <div style="margin-top:8px; font-size:0.8rem; color:#666">ğŸª ${stores[sid].name}</div>
                                </div>`;
                                count++;
                            }
                        });
                    });
                    if(count === 0) list.innerHTML = "<p style='text-align:center; margin-top:40px; color:#999;'>Ù†Ø¹ØªØ°Ø±ØŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…</p>";
                });
            });
        }

        // ÙØªØ­ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø­Ù„Ø§Øª
        function openDir(cat) {
            playWater(); 
            document.getElementById('dirTitle').innerText = "Ø¯Ù„ÙŠÙ„ " + cat;
            const list = document.getElementById('dirList'); 
            list.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„..."; 
            openPage('dirPage');
            db.ref('Stores').orderByChild('category').equalTo(cat).once('value', snap => {
                list.innerHTML = "";
                if(!snap.exists()) { list.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ù„Ø§Øª Ù…Ø³Ø¬Ù„Ø©"; return; }
                snap.forEach(s => {
                    const data = s.val();
                    list.innerHTML += `<div class="product-card" onclick="window.open('tel:${data.phone}')">
                        <b>${data.name}</b><br>
                        <small>ğŸ“ Ø§Ø¶ØºØ· Ù„Ù„Ø§ØªØµØ§Ù„: ${data.phone}</small>
                    </div>`;
                });
            });
        }

        // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¨Ø­Ø«
        function searchStores() {
            let filter = document.getElementById('searchInp').value.toLowerCase();
            let cards = document.querySelectorAll('#dirList .product-card');
            cards.forEach(card => {
                card.style.display = card.innerText.toLowerCase().includes(filter) ? "" : "none";
            });
        }

        // Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ§Ø¬Ø±
        function loginMerchant() {
            const code = document.getElementById('mCode').value;
            if(!code) return;
            db.ref('Stores/'+code).once('value', s => {
                if(s.exists()){ 
                    localStorage.setItem('storeKey', code); 
                    localStorage.setItem('storeName', s.val().name); 
                    checkAuth(); 
                    playWater(); 
                } else { alert("ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­!"); }
            });
        }

        function checkAuth() {
            const key = localStorage.getItem('storeKey');
            if(key) { 
                document.getElementById('mAuth').style.display='none'; 
                document.getElementById('mPanel').style.display='block'; 
                document.getElementById('mNameDisp').innerText = "ğŸª Ù…ØªØ¬Ø±: " + localStorage.getItem('storeName');
                loadMyProds(key);
            }
        }

        function addProduct() {
            const key = localStorage.getItem('storeKey');
            const name = document.getElementById('pName').value;
            const price = document.getElementById('pPrice').value;
            const type = document.getElementById('pType').value;
            if(!name || !price) { alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); return; }
            db.ref('Products/'+key).push({ name, price, type }).then(() => {
                document.getElementById('pName').value=""; 
                document.getElementById('pPrice').value=""; 
                playWater();
            });
        }

        function loadMyProds(key) {
            db.ref('Products/'+key).on('value', snap => {
                const list = document.getElementById('mProds'); list.innerHTML = "";
                snap.forEach(p => {
                    const item = p.val();
                    list.innerHTML += `<div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; background:white; margin-bottom:5px; border-radius:10px;">
                        <div><b>${item.name}</b> <br> <small style="color:var(--orange)">${item.price} (${item.type === 'offer' ? 'Ø¹Ø±ÙˆØ¶' : 'Ø¹Ø§Ø¯ÙŠ'})</small></div>
                        <button onclick="delP('${p.key}')" style="color:white; background:#e74c3c; border:none; padding:5px 10px; border-radius:8px; cursor:pointer;">Ø­Ø°Ù</button>
                    </div>`;
                });
            });
        }

        function delP(pid) { if(confirm("Ù‡Ù„ Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) db.ref('Products/'+localStorage.getItem('storeKey')+'/'+pid).remove(); }
        function logout() { localStorage.clear(); location.reload(); }
        function sendAns() { playWater(); window.open('https://wa.me/967776337604', '_blank'); }
    </script>
</body>
</html>